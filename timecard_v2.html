<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>勤怠管理システム</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f7f5f2;
  --surface: #ffffff;
  --border: #e4dfd8;
  --ink: #1c1917;
  --ink2: #78716c;
  --ink3: #b5afa9;
  --in-color: #16a34a;
  --in-bg: #f0fdf4;
  --in-border: #86efac;
  --out-color: #dc2626;
  --out-bg: #fef2f2;
  --out-border: #fca5a5;
  --accent: #0f766e;
  --accent-light: #f0fdfa;
  --r: 14px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'Noto Sans JP', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ═══ TOP BAR ═══ */
.topbar {
  background: var(--ink);
  padding: 0 24px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky; top: 0; z-index: 200;
}

.brand {
  color: rgba(255,255,255,0.9);
  font-family: 'DM Mono', monospace;
  font-size: 13px;
  letter-spacing: 0.12em;
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 20px;
}

.live-time {
  font-family: 'DM Mono', monospace;
  font-size: 22px;
  color: #fff;
  font-weight: 500;
}

.live-date {
  font-size: 12px;
  color: rgba(255,255,255,0.55);
  text-align: right;
  line-height: 1.5;
}

.admin-link {
  padding: 7px 14px;
  border: 1px solid rgba(255,255,255,0.25);
  border-radius: 8px;
  color: rgba(255,255,255,0.7);
  font-size: 12px;
  cursor: pointer;
  background: none;
  font-family: 'Noto Sans JP', sans-serif;
  transition: all 0.15s;
}
.admin-link:hover { border-color: rgba(255,255,255,0.6); color: #fff; }

/* ═══ MAIN CLOCK SCREEN ═══ */
.clock-screen {
  max-width: 680px;
  margin: 0 auto;
  padding: 28px 20px;
}

.screen-title {
  text-align: center;
  font-size: 12px;
  letter-spacing: 0.15em;
  color: var(--ink3);
  font-family: 'DM Mono', monospace;
  text-transform: uppercase;
  margin-bottom: 24px;
}

/* Staff grid */
.staff-grid-label {
  font-size: 13px;
  color: var(--ink2);
  margin-bottom: 12px;
  font-weight: 500;
}

.staff-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
  margin-bottom: 28px;
}

.staff-btn {
  position: relative;
  padding: 18px 12px;
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--r);
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
  font-family: 'Noto Sans JP', sans-serif;
}

.staff-btn:active { transform: scale(0.97); }

.staff-btn.selected {
  border-color: var(--accent);
  background: var(--accent-light);
  box-shadow: 0 0 0 3px rgba(15,118,110,0.12);
}

.staff-btn .s-name {
  font-size: 15px;
  font-weight: 700;
  color: var(--ink);
  display: block;
  margin-bottom: 5px;
}

.staff-btn .s-status {
  font-size: 11px;
  font-family: 'DM Mono', monospace;
  display: block;
}

.staff-btn.status-in .s-status { color: var(--in-color); }
.staff-btn.status-out .s-status { color: var(--ink3); }
.staff-btn.status-done .s-status { color: var(--ink3); }

.staff-btn .s-dot {
  position: absolute;
  top: 8px; right: 8px;
  width: 8px; height: 8px;
  border-radius: 50%;
}

.staff-btn.status-in .s-dot { background: var(--in-color); box-shadow: 0 0 0 2px rgba(22,163,74,0.3); animation: pulse 2s infinite; }
.staff-btn.status-done .s-dot { background: var(--ink3); }

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 2px rgba(22,163,74,0.3); }
  50% { box-shadow: 0 0 0 5px rgba(22,163,74,0.1); }
}

/* Action panel */
.action-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 24px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.07);
}

.action-hint {
  text-align: center;
  padding: 32px 20px;
  color: var(--ink3);
  font-size: 14px;
}

.selected-info {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}

.selected-name {
  font-size: 22px;
  font-weight: 900;
  color: var(--ink);
}

.selected-time-info {
  text-align: right;
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  color: var(--ink2);
  line-height: 1.8;
}

.action-btns {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.action-btn {
  padding: 22px 16px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 17px;
  font-weight: 700;
  font-family: 'Noto Sans JP', sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  transition: all 0.15s;
  position: relative;
  overflow: hidden;
}

.action-btn:active { transform: scale(0.97); }

.action-btn .btn-icon { font-size: 28px; line-height: 1; }
.action-btn .btn-eng { font-size: 11px; font-weight: 400; opacity: 0.7; font-family: 'DM Mono', monospace; letter-spacing: 0.05em; }

.btn-in {
  background: var(--in-bg);
  border: 2px solid var(--in-border);
  color: var(--in-color);
}
.btn-in:hover:not(:disabled) { background: #dcfce7; border-color: var(--in-color); box-shadow: 0 4px 16px rgba(22,163,74,0.2); }

.btn-out {
  background: var(--out-bg);
  border: 2px solid var(--out-border);
  color: var(--out-color);
}
.btn-out:hover:not(:disabled) { background: #fee2e2; border-color: var(--out-color); box-shadow: 0 4px 16px rgba(220,38,38,0.2); }

.action-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none !important;
}

/* Toast */
.toast-bar {
  position: fixed;
  bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--ink);
  color: #fff;
  padding: 14px 28px;
  border-radius: 50px;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  z-index: 999;
  transition: transform 0.3s cubic-bezier(.34,1.56,.64,1);
  white-space: nowrap;
  max-width: 90vw;
  text-align: center;
}
.toast-bar.show { transform: translateX(-50%) translateY(0); }
.toast-bar.success { background: #166534; }
.toast-bar.error { background: #991b1b; }

/* ═══ ADMIN OVERLAY ═══ */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 500;
  backdrop-filter: blur(4px);
  align-items: flex-start;
  justify-content: center;
  padding: 20px;
  overflow-y: auto;
}
.overlay.open { display: flex; }

.modal {
  background: var(--surface);
  border-radius: 20px;
  width: 100%;
  max-width: 760px;
  box-shadow: 0 24px 80px rgba(0,0,0,0.3);
  overflow: hidden;
  margin: auto;
}

.modal-header {
  background: var(--ink);
  color: #fff;
  padding: 20px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-header h2 {
  font-size: 15px;
  font-family: 'DM Mono', monospace;
  letter-spacing: 0.1em;
}

.modal-close {
  width: 36px; height: 36px;
  border: none;
  background: rgba(255,255,255,0.15);
  color: #fff;
  border-radius: 8px;
  font-size: 18px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.modal-close:hover { background: rgba(255,255,255,0.25); }

.modal-body {
  padding: 24px 28px;
}

/* Tabs inside modal */
.modal-tabs {
  display: flex;
  gap: 4px;
  background: var(--bg);
  padding: 6px;
  border-radius: 12px;
  margin-bottom: 24px;
}

.m-tab {
  flex: 1;
  padding: 9px;
  border: none;
  border-radius: 8px;
  background: none;
  font-size: 13px;
  cursor: pointer;
  font-family: 'Noto Sans JP', sans-serif;
  color: var(--ink2);
  transition: all 0.15s;
}
.m-tab.active { background: var(--surface); color: var(--ink); font-weight: 700; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }

.modal-tab-panel { display: none; }
.modal-tab-panel.active { display: block; }

/* Password screen */
.pw-screen {
  max-width: 340px;
  margin: 0 auto;
  padding: 40px 0;
  text-align: center;
}

.pw-screen p { font-size: 14px; color: var(--ink2); margin-bottom: 20px; }

.pw-row {
  display: flex;
  gap: 8px;
}

.pw-input {
  flex: 1;
  padding: 12px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 15px;
  text-align: center;
  letter-spacing: 0.2em;
  font-family: 'DM Mono', monospace;
}
.pw-input:focus { outline: none; border-color: var(--accent); }

.pw-btn {
  padding: 12px 20px;
  background: var(--ink);
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 13px;
  cursor: pointer;
  font-family: 'Noto Sans JP', sans-serif;
}
.pw-btn:hover { background: #333; }

.pw-error { color: #dc2626; font-size: 12px; margin-top: 8px; }

/* Staff management */
.section-label {
  font-size: 11px;
  font-family: 'DM Mono', monospace;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--ink3);
  margin-bottom: 10px;
}

.staff-list-admin { margin-bottom: 20px; }

.staff-row-admin {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 11px 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
  margin-bottom: 6px;
  background: var(--bg);
  font-size: 14px;
  font-weight: 500;
}

.del-btn {
  padding: 5px 12px;
  border: 1.5px solid #fca5a5;
  border-radius: 7px;
  background: none;
  color: #dc2626;
  font-size: 12px;
  cursor: pointer;
  font-family: 'Noto Sans JP', sans-serif;
}
.del-btn:hover { background: #fef2f2; }

.add-row {
  display: flex;
  gap: 8px;
}

.add-row input {
  flex: 1;
  padding: 10px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  font-family: 'Noto Sans JP', sans-serif;
  background: var(--surface);
}
.add-row input:focus { outline: none; border-color: var(--accent); }

.add-btn {
  padding: 10px 18px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 13px;
  cursor: pointer;
  font-family: 'Noto Sans JP', sans-serif;
  font-weight: 700;
  white-space: nowrap;
}
.add-btn:hover { background: #0f5e58; }

/* Month controls */
.month-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.month-nav {
  display: flex;
  align-items: center;
  gap: 6px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 5px;
}

.nav-btn {
  width: 30px; height: 30px;
  border: none; background: none;
  border-radius: 7px;
  cursor: pointer;
  font-size: 16px;
  color: var(--ink2);
  display: flex; align-items: center; justify-content: center;
}
.nav-btn:hover { background: var(--surface); }

.month-lbl {
  font-family: 'DM Mono', monospace;
  font-size: 14px;
  min-width: 90px;
  text-align: center;
  font-weight: 500;
}

.staff-filter-sel {
  padding: 7px 12px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  font-size: 13px;
  font-family: 'Noto Sans JP', sans-serif;
  background: var(--surface);
  cursor: pointer;
}
.staff-filter-sel:focus { outline: none; border-color: var(--accent); }

.export-btn {
  margin-left: auto;
  padding: 8px 16px;
  background: var(--ink);
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 12px;
  cursor: pointer;
  font-family: 'DM Mono', monospace;
  letter-spacing: 0.05em;
}
.export-btn:hover { background: #333; }

/* Summary strip */
.summary-strip {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 8px;
  margin-bottom: 16px;
}

.s-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 14px;
}
.s-card .s-lbl { font-size: 10px; color: var(--ink3); font-family: 'DM Mono', monospace; letter-spacing: 0.08em; text-transform: uppercase; }
.s-card .s-val { font-size: 22px; font-family: 'DM Mono', monospace; font-weight: 500; margin-top: 2px; }

/* Table */
.tbl-wrap {
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 20px;
}
.tbl-scroll { overflow-x: auto; }

table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead tr { background: #2c2724; color: #fff; }
thead th {
  padding: 10px 13px;
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.08em;
  text-align: left;
  white-space: nowrap;
  font-weight: 500;
}
thead th:not(:nth-child(1)):not(:nth-child(2)) { text-align: center; }

tbody tr { border-bottom: 1px solid var(--border); }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: var(--bg); }

td { padding: 10px 13px; white-space: nowrap; }
td:not(:nth-child(1)):not(:nth-child(2)) { text-align: center; }

.td-mono { font-family: 'DM Mono', monospace; font-size: 12px; }
.td-hours { font-family: 'DM Mono', monospace; font-weight: 700; color: var(--accent); }
.td-warn { color: #d97706; font-size: 11px; }
.td-err { color: #dc2626; font-size: 11px; }

.sum-row { background: #f0fdfa !important; font-weight: 700; border-top: 2px solid var(--accent) !important; }

/* Manual edit form */
.edit-form {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr auto;
  gap: 10px;
  align-items: end;
  margin-top: 16px;
}

.fg label { display: block; font-size: 11px; color: var(--ink2); margin-bottom: 4px; }
.fg input, .fg select {
  width: 100%;
  padding: 9px 10px;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  font-size: 13px;
  font-family: 'Noto Sans JP', sans-serif;
  background: var(--bg);
}
.fg input:focus, .fg select:focus { outline: none; border-color: var(--accent); }

.save-btn {
  padding: 10px 16px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  cursor: pointer;
  font-family: 'Noto Sans JP', sans-serif;
  font-weight: 700;
  white-space: nowrap;
}
.save-btn:hover { background: #0f5e58; }

.no-data { padding: 40px; text-align: center; color: var(--ink3); font-size: 13px; }

/* change PW */
.change-pw-form { display: flex; flex-direction: column; gap: 10px; max-width: 320px; }
.change-pw-form input {
  padding: 10px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  font-family: 'DM Mono', monospace;
  letter-spacing: 0.15em;
  text-align: center;
}
.change-pw-form input:focus { outline: none; border-color: var(--accent); }

@media (max-width: 600px) {
  .staff-grid { grid-template-columns: repeat(2, 1fr); }
  .action-btns { grid-template-columns: 1fr 1fr; }
  .edit-form { grid-template-columns: 1fr 1fr; }
  .topbar { padding: 0 14px; }
  .brand { display: none; }
  .modal-body { padding: 16px; }
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="brand">// TIMECARD</div>
  <div class="topbar-right">
    <div>
      <div class="live-time" id="live-clock">--:--</div>
    </div>
    <div class="live-date" id="live-date"></div>
    <button class="admin-link" onclick="openAdmin()">管理者</button>
  </div>
</div>

<!-- CLOCK SCREEN -->
<div class="clock-screen">
  <div class="screen-title">スタッフを選んで打刻してください</div>

  <div class="staff-grid-label">スタッフ一覧</div>
  <div class="staff-grid" id="staff-grid">
    <div style="color:var(--ink3);font-size:13px;grid-column:1/-1;padding:16px 0;">管理者画面からスタッフを登録してください</div>
  </div>

  <div class="action-panel" id="action-panel">
    <div class="action-hint" id="action-hint">← スタッフ名を選択すると打刻できます</div>
    <div id="action-content" style="display:none">
      <div class="selected-info">
        <div class="selected-name" id="sel-name"></div>
        <div class="selected-time-info" id="sel-time-info"></div>
      </div>
      <div class="action-btns">
        <button class="action-btn btn-in" id="btn-in" onclick="doClock('in')">
          <span class="btn-icon">▶</span>
          <span>出勤</span>
          <span class="btn-eng">CLOCK IN</span>
        </button>
        <button class="action-btn btn-out" id="btn-out" onclick="doClock('out')">
          <span class="btn-icon">■</span>
          <span>退勤</span>
          <span class="btn-eng">CLOCK OUT</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast-bar" id="toast"></div>

<!-- ═══ ADMIN OVERLAY ═══ -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>// 管理者メニュー</h2>
      <button class="modal-close" onclick="closeAdmin()">✕</button>
    </div>
    <div class="modal-body">

      <!-- Password Gate -->
      <div id="pw-gate">
        <div class="pw-screen">
          <p>管理者パスワードを入力してください</p>
          <div class="pw-row">
            <input type="password" class="pw-input" id="pw-input" placeholder="パスワード" onkeydown="if(event.key==='Enter')checkPW()">
            <button class="pw-btn" onclick="checkPW()">入室</button>
          </div>
          <div class="pw-error" id="pw-error"></div>
          <div style="margin-top:20px;font-size:11px;color:var(--ink3);">初期パスワード: <span style="font-family:'DM Mono',monospace;letter-spacing:0.1em;">admin1234</span></div>
        </div>
      </div>

      <!-- Admin Content -->
      <div id="admin-content" style="display:none">
        <div class="modal-tabs">
          <button class="m-tab active" onclick="showMTab('tab-staff')">スタッフ管理</button>
          <button class="m-tab" onclick="showMTab('tab-monthly')">勤務表</button>
          <button class="m-tab" onclick="showMTab('tab-edit')">打刻修正</button>
          <button class="m-tab" onclick="showMTab('tab-settings')">設定</button>
        </div>

        <!-- Tab: Staff -->
        <div class="modal-tab-panel active" id="tab-staff">
          <div class="section-label">登録スタッフ</div>
          <div class="staff-list-admin" id="staff-list-admin"></div>
          <div class="section-label" style="margin-top:16px">スタッフ追加</div>
          <div class="add-row">
            <input type="text" id="new-staff" placeholder="氏名を入力（例：山田 太郎）" maxlength="20" onkeydown="if(event.key==='Enter')addStaff()">
            <button class="add-btn" onclick="addStaff()">追加</button>
          </div>
        </div>

        <!-- Tab: Monthly -->
        <div class="modal-tab-panel" id="tab-monthly">
          <div class="month-row">
            <div class="month-nav">
              <button class="nav-btn" onclick="changeMonth(-1)">‹</button>
              <span class="month-lbl" id="m-month-lbl"></span>
              <button class="nav-btn" onclick="changeMonth(1)">›</button>
            </div>
            <select class="staff-filter-sel" id="m-staff-filter" onchange="renderMonthly()">
              <option value="">全スタッフ</option>
            </select>
            <button class="export-btn" onclick="exportCSV()">CSV 出力</button>
          </div>

          <div class="summary-strip" id="m-summary"></div>

          <div class="tbl-wrap">
            <div class="tbl-scroll">
              <table>
                <thead>
                  <tr><th>日付</th><th>スタッフ</th><th>出勤</th><th>退勤</th><th>労働時間</th><th>備考</th></tr>
                </thead>
                <tbody id="m-tbody"></tbody>
              </table>
            </div>
          </div>

          <div class="section-label">スタッフ別集計</div>
          <div class="tbl-wrap">
            <table>
              <thead>
                <tr><th>スタッフ</th><th>勤務日数</th><th>総労働時間</th><th>平均/日</th></tr>
              </thead>
              <tbody id="m-staff-tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- Tab: Edit -->
        <div class="modal-tab-panel" id="tab-edit">
          <div class="section-label">打刻データ 手動入力・修正</div>
          <p style="font-size:12px;color:var(--ink2);margin-bottom:4px;">既存データがある場合は上書きされます。</p>
          <div class="edit-form">
            <div class="fg"><label>スタッフ</label><select id="e-staff"></select></div>
            <div class="fg"><label>日付</label><input type="date" id="e-date"></div>
            <div class="fg"><label>出勤</label><input type="time" id="e-in"></div>
            <div class="fg"><label>退勤</label><input type="time" id="e-out"></div>
            <button class="save-btn" onclick="saveEdit()">保存</button>
          </div>

          <div style="margin-top:28px">
            <div class="section-label">全打刻ログ</div>
            <div class="tbl-wrap">
              <div class="tbl-scroll">
                <table>
                  <thead><tr><th>日付</th><th>スタッフ</th><th>出勤</th><th>退勤</th><th>労働時間</th><th></th></tr></thead>
                  <tbody id="log-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Settings -->
        <div class="modal-tab-panel" id="tab-settings">
          <div class="section-label">管理者パスワード変更</div>
          <div class="change-pw-form">
            <input type="password" id="pw-current" placeholder="現在のパスワード">
            <input type="password" id="pw-new" placeholder="新しいパスワード">
            <input type="password" id="pw-new2" placeholder="新しいパスワード（確認）">
            <button class="add-btn" style="width:fit-content" onclick="changePW()">変更する</button>
            <div id="pw-change-msg" style="font-size:12px;margin-top:4px;"></div>
          </div>
        </div>

      </div><!-- /admin-content -->
    </div>
  </div>
</div>

<script>
// ═══ DATA ═══
const SK = { staff: 'tc2_staff', rec: 'tc2_records', pw: 'tc2_pw' };

function ls(key) { try { return JSON.parse(localStorage.getItem(key)) || null; } catch { return null; } }
function ss(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

function getStaff() { return ls(SK.staff) || []; }
function setStaff(v) { ss(SK.staff, v); }
function getRec() { return ls(SK.rec) || []; }
function setRec(v) { ss(SK.rec, v); }
function getPW() { return ls(SK.pw) || 'admin1234'; }
function setPW(v) { ss(SK.pw, v); }

function getRecord(staff, date) { return getRec().find(r => r.staff === staff && r.date === date) || null; }

function upsert(rec) {
  const arr = getRec();
  const i = arr.findIndex(r => r.staff === rec.staff && r.date === rec.date);
  if (i >= 0) arr[i] = rec; else arr.push(rec);
  setRec(arr);
}

function deleteRec(staff, date) { setRec(getRec().filter(r => !(r.staff === staff && r.date === date))); }

// ═══ UTILS ═══
const pad = n => String(n).padStart(2, '0');

function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function nowHM() {
  const d = new Date();
  return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function calcMins(inT, outT) {
  if (!inT || !outT) return null;
  const [ih, im] = inT.split(':').map(Number);
  const [oh, om] = outT.split(':').map(Number);
  const diff = (oh * 60 + om) - (ih * 60 + im) - 60;
  return diff > 0 ? diff : 0;
}

function fmt(mins) {
  if (mins === null || mins === undefined) return '--';
  return `${Math.floor(mins/60)}:${pad(mins%60)}`;
}

const DAYS = ['日','月','火','水','木','金','土'];
function fmtDate(s) {
  const d = new Date(s + 'T00:00:00');
  return `${d.getMonth()+1}/${d.getDate()}（${DAYS[d.getDay()]}）`;
}

// Period: 16th ~ next 15th
let curYear, curMonth;
(function() {
  const n = new Date();
  if (n.getDate() >= 16) { curYear = n.getFullYear(); curMonth = n.getMonth()+1; }
  else {
    const p = new Date(n.getFullYear(), n.getMonth()-1, 1);
    curYear = p.getFullYear(); curMonth = p.getMonth()+1;
  }
})();

function periodRange(y, m) {
  return { start: new Date(y, m-1, 16), end: new Date(y, m, 15) };
}

function inPeriod(dateStr, y, m) {
  const d = new Date(dateStr + 'T00:00:00');
  const { start, end } = periodRange(y, m);
  return d >= start && d <= end;
}

// ═══ CLOCK ═══
function updateClock() {
  const n = new Date();
  document.getElementById('live-clock').textContent = `${pad(n.getHours())}:${pad(n.getMinutes())}`;
  document.getElementById('live-date').textContent = `${n.getMonth()+1}月${n.getDate()}日（${DAYS[n.getDay()]}）`;
}
setInterval(updateClock, 1000);
updateClock();

// ═══ STAFF GRID ═══
let selectedStaff = null;

function renderStaffGrid() {
  const staff = getStaff();
  const grid = document.getElementById('staff-grid');
  if (!staff.length) {
    grid.innerHTML = '<div style="color:var(--ink3);font-size:13px;grid-column:1/-1;padding:16px 0;">管理者画面からスタッフを登録してください</div>';
    return;
  }
  const today = todayStr();
  grid.innerHTML = staff.map(s => {
    const r = getRecord(s, today);
    let cls = 'status-none', dot = '', statusTxt = '未打刻';
    if (r && r.clockIn && !r.clockOut) { cls = 'status-in'; dot = '<span class="s-dot"></span>'; statusTxt = `出勤中 ${r.clockIn}`; }
    else if (r && r.clockIn && r.clockOut) { cls = 'status-done'; dot = '<span class="s-dot"></span>'; statusTxt = `退勤済 ${r.clockOut}`; }
    const sel = selectedStaff === s ? ' selected' : '';
    return `<button class="staff-btn ${cls}${sel}" onclick="selectStaff('${s}')">
      ${dot}
      <span class="s-name">${s}</span>
      <span class="s-status">${statusTxt}</span>
    </button>`;
  }).join('');
}

function selectStaff(name) {
  selectedStaff = name;
  renderStaffGrid();
  updateActionPanel();
}

function updateActionPanel() {
  const hint = document.getElementById('action-hint');
  const content = document.getElementById('action-content');
  if (!selectedStaff) { hint.style.display=''; content.style.display='none'; return; }
  hint.style.display = 'none';
  content.style.display = 'block';

  document.getElementById('sel-name').textContent = selectedStaff;

  const today = todayStr();
  const r = getRecord(selectedStaff, today);
  let info = '';
  if (r && r.clockIn) info += `出勤 ${r.clockIn}`;
  if (r && r.clockOut) info += `　退勤 ${r.clockOut}`;
  if (!r || !r.clockIn) info = '本日未打刻';
  document.getElementById('sel-time-info').textContent = info;

  const canIn  = !r || !r.clockIn;
  const canOut = r && r.clockIn && !r.clockOut;
  document.getElementById('btn-in').disabled  = !canIn;
  document.getElementById('btn-out').disabled = !canOut;
}

function doClock(type) {
  if (!selectedStaff) return;
  const today = todayStr();
  let r = getRecord(selectedStaff, today) || { staff: selectedStaff, date: today, clockIn: null, clockOut: null };

  if (type === 'in') {
    if (r.clockIn) { showToast('既に出勤打刻済みです', 'error'); return; }
    r.clockIn = nowHM();
    upsert(r);
    showToast(`${selectedStaff}　出勤打刻 ${r.clockIn}`, 'success');
  } else {
    if (!r.clockIn) { showToast('出勤打刻がありません', 'error'); return; }
    if (r.clockOut) { showToast('既に退勤打刻済みです', 'error'); return; }
    r.clockOut = nowHM();
    upsert(r);
    const m = calcMins(r.clockIn, r.clockOut);
    showToast(`${selectedStaff}　退勤打刻 ${r.clockOut}　労働時間 ${fmt(m)}`, 'success');
  }

  selectedStaff = null;
  renderStaffGrid();
  updateActionPanel();
}

// ═══ TOAST ═══
let toastTimer;
function showToast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast-bar show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3500);
}

// ═══ ADMIN ═══
let adminOpen = false;
let adminAuthed = false;

function openAdmin() {
  document.getElementById('overlay').classList.add('open');
  if (!adminAuthed) {
    document.getElementById('pw-gate').style.display = '';
    document.getElementById('admin-content').style.display = 'none';
    document.getElementById('pw-input').value = '';
    document.getElementById('pw-error').textContent = '';
    setTimeout(() => document.getElementById('pw-input').focus(), 100);
  }
}

function closeAdmin() {
  document.getElementById('overlay').classList.remove('open');
}

document.getElementById('overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('overlay')) closeAdmin();
});

function checkPW() {
  const val = document.getElementById('pw-input').value;
  if (val === getPW()) {
    adminAuthed = true;
    document.getElementById('pw-gate').style.display = 'none';
    document.getElementById('admin-content').style.display = '';
    refreshAdminSelects();
    renderStaffListAdmin();
    renderMonthly();
    renderLog();
    document.getElementById('e-date').value = todayStr();
  } else {
    document.getElementById('pw-error').textContent = 'パスワードが違います';
  }
}

function showMTab(id) {
  document.querySelectorAll('.modal-tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.m-tab').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const tabs = ['tab-staff','tab-monthly','tab-edit','tab-settings'];
  document.querySelectorAll('.m-tab')[tabs.indexOf(id)].classList.add('active');
  if (id === 'tab-monthly') renderMonthly();
  if (id === 'tab-edit') renderLog();
}

// ── Staff admin ──
function refreshAdminSelects() {
  const staff = getStaff();
  ['m-staff-filter','e-staff'].forEach(id => {
    const el = document.getElementById(id);
    const prev = el.value;
    if (id === 'm-staff-filter') el.innerHTML = '<option value="">全スタッフ</option>';
    else el.innerHTML = '';
    staff.forEach(s => {
      const o = document.createElement('option');
      o.value = s; o.textContent = s;
      el.appendChild(o);
    });
    if (staff.includes(prev)) el.value = prev;
  });
}

function renderStaffListAdmin() {
  const staff = getStaff();
  const el = document.getElementById('staff-list-admin');
  el.innerHTML = staff.length
    ? staff.map(s => `<div class="staff-row-admin"><span>${s}</span><button class="del-btn" onclick="removeStaff('${s}')">削除</button></div>`).join('')
    : '<div style="color:var(--ink3);font-size:13px;padding:8px 0;">登録されていません</div>';
}

function addStaff() {
  const inp = document.getElementById('new-staff');
  const name = inp.value.trim();
  if (!name) return;
  const s = getStaff();
  if (s.includes(name)) { inp.value = ''; return; }
  s.push(name);
  setStaff(s);
  inp.value = '';
  refreshAdminSelects();
  renderStaffListAdmin();
  renderStaffGrid();
  showToast(`${name} を登録しました`, 'success');
}

function removeStaff(name) {
  if (!confirm(`「${name}」を削除しますか？（打刻データは残ります）`)) return;
  setStaff(getStaff().filter(x => x !== name));
  refreshAdminSelects();
  renderStaffListAdmin();
  renderStaffGrid();
}

// ── Monthly ──
function changeMonth(d) {
  curMonth += d;
  if (curMonth > 12) { curMonth = 1; curYear++; }
  if (curMonth < 1)  { curMonth = 12; curYear--; }
  renderMonthly();
}

function renderMonthly() {
  const { start, end } = periodRange(curYear, curMonth);
  document.getElementById('m-month-lbl').textContent = `${curYear}.${pad(curMonth)}`;

  const filter = document.getElementById('m-staff-filter').value;
  let recs = getRec().filter(r => inPeriod(r.date, curYear, curMonth));
  if (filter) recs = recs.filter(r => r.staff === filter);
  recs.sort((a,b) => a.date.localeCompare(b.date) || a.staff.localeCompare(b.staff));

  // Summary strip
  const staffSet = [...new Set(recs.map(r => r.staff))];
  const days = new Set(recs.filter(r => r.clockIn).map(r => r.date)).size;
  let totalM = 0;
  recs.forEach(r => { const m = calcMins(r.clockIn, r.clockOut); if (m) totalM += m; });
  const period = `${start.getMonth()+1}/${start.getDate()} 〜 ${end.getMonth()+1}/${end.getDate()}`;

  document.getElementById('m-summary').innerHTML = `
    <div class="s-card"><div class="s-lbl">集計期間</div><div class="s-val" style="font-size:13px;margin-top:4px;">${curYear}年${curMonth}月期</div><div style="font-size:11px;color:var(--ink3)">${period}</div></div>
    <div class="s-card"><div class="s-lbl">スタッフ数</div><div class="s-val">${staffSet.length}<span style="font-size:13px">名</span></div></div>
    <div class="s-card"><div class="s-lbl">延べ勤務日数</div><div class="s-val">${days}<span style="font-size:13px">日</span></div></div>
    <div class="s-card"><div class="s-lbl">総労働時間</div><div class="s-val">${fmt(totalM)}</div><div style="font-size:10px;color:var(--ink3)">休憩1h控除後</div></div>
  `;

  // Detail table
  const tbody = document.getElementById('m-tbody');
  if (!recs.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="no-data">この期間のデータがありません</td></tr>';
  } else {
    tbody.innerHTML = recs.map(r => {
      const m = calcMins(r.clockIn, r.clockOut);
      const note = !r.clockIn ? '<span class="td-err">出勤未打刻</span>'
                 : !r.clockOut ? '<span class="td-warn">退勤未打刻</span>'
                 : '';
      return `<tr>
        <td>${fmtDate(r.date)}</td>
        <td>${r.staff}</td>
        <td class="td-mono">${r.clockIn || '<span style="color:var(--ink3)">--</span>'}</td>
        <td class="td-mono">${r.clockOut || '<span style="color:var(--ink3)">--</span>'}</td>
        <td class="td-hours">${m !== null ? fmt(m) : '<span style="color:var(--ink3)">--</span>'}</td>
        <td>${note}</td>
      </tr>`;
    }).join('');
  }

  // Staff summary table
  const byStaff = {};
  recs.forEach(r => {
    if (!byStaff[r.staff]) byStaff[r.staff] = { days: 0, mins: 0 };
    if (r.clockIn) byStaff[r.staff].days++;
    const m = calcMins(r.clockIn, r.clockOut);
    if (m) byStaff[r.staff].mins += m;
  });
  const entries = Object.entries(byStaff);
  const sTbody = document.getElementById('m-staff-tbody');
  if (!entries.length) {
    sTbody.innerHTML = '<tr><td colspan="4" class="no-data">データなし</td></tr>';
  } else {
    sTbody.innerHTML = entries.map(([name, d]) => {
      const avg = d.days ? Math.round(d.mins / d.days) : 0;
      return `<tr>
        <td style="font-weight:600">${name}</td>
        <td class="td-mono" style="text-align:center">${d.days}日</td>
        <td class="td-hours" style="text-align:center">${fmt(d.mins)}</td>
        <td class="td-mono" style="text-align:center">${fmt(avg)}</td>
      </tr>`;
    }).join('') + `<tr class="sum-row">
      <td>合計</td>
      <td class="td-mono" style="text-align:center">${days}日</td>
      <td class="td-hours" style="text-align:center">${fmt(totalM)}</td>
      <td></td>
    </tr>`;
  }
}

// ── Log & Edit ──
function renderLog() {
  const recs = getRec().sort((a,b) => b.date.localeCompare(a.date) || a.staff.localeCompare(b.staff));
  const tbody = document.getElementById('log-tbody');
  tbody.innerHTML = recs.length ? recs.map(r => {
    const m = calcMins(r.clockIn, r.clockOut);
    return `<tr>
      <td>${fmtDate(r.date)}</td>
      <td>${r.staff}</td>
      <td class="td-mono">${r.clockIn || '--'}</td>
      <td class="td-mono">${r.clockOut || '--'}</td>
      <td class="td-hours">${m !== null ? fmt(m) : '--'}</td>
      <td><button class="del-btn" onclick="delLog('${r.staff}','${r.date}')">削除</button></td>
    </tr>`;
  }).join('') : '<tr><td colspan="6" class="no-data">ログなし</td></tr>';
}

function delLog(staff, date) {
  if (!confirm(`${staff} / ${date} の打刻を削除しますか？`)) return;
  deleteRec(staff, date);
  renderLog();
  renderMonthly();
}

function saveEdit() {
  const staff = document.getElementById('e-staff').value;
  const date  = document.getElementById('e-date').value;
  const inT   = document.getElementById('e-in').value || null;
  const outT  = document.getElementById('e-out').value || null;
  if (!staff || !date) { showToast('スタッフと日付は必須です', 'error'); return; }
  upsert({ staff, date, clockIn: inT, clockOut: outT });
  showToast(`保存しました：${staff} / ${date}`, 'success');
  renderLog();
  renderStaffGrid();
}

// ── CSV ──
function exportCSV() {
  const filter = document.getElementById('m-staff-filter').value;
  let recs = getRec().filter(r => inPeriod(r.date, curYear, curMonth));
  if (filter) recs = recs.filter(r => r.staff === filter);
  recs.sort((a,b) => a.date.localeCompare(b.date) || a.staff.localeCompare(b.staff));

  const { start, end } = periodRange(curYear, curMonth);
  const header = ['日付','スタッフ','出勤','退勤','労働時間（h:mm）'];
  const rows = recs.map(r => {
    const m = calcMins(r.clockIn, r.clockOut);
    return [r.date, r.staff, r.clockIn||'', r.clockOut||'', m !== null ? fmt(m) : ''];
  });

  const csv = [header,...rows].map(r => r.join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `勤務表_${curYear}年${curMonth}月期.csv`;
  a.click();
}

// ── Password change ──
function changePW() {
  const cur  = document.getElementById('pw-current').value;
  const nw   = document.getElementById('pw-new').value;
  const nw2  = document.getElementById('pw-new2').value;
  const msg  = document.getElementById('pw-change-msg');
  if (cur !== getPW()) { msg.textContent = '現在のパスワードが違います'; msg.style.color='#dc2626'; return; }
  if (!nw) { msg.textContent = '新しいパスワードを入力してください'; msg.style.color='#dc2626'; return; }
  if (nw !== nw2) { msg.textContent = '確認パスワードが一致しません'; msg.style.color='#dc2626'; return; }
  setPW(nw);
  ['pw-current','pw-new','pw-new2'].forEach(id => document.getElementById(id).value='');
  msg.textContent = 'パスワードを変更しました';
  msg.style.color = '#16a34a';
}

// ═══ INIT ═══
renderStaffGrid();
updateActionPanel();
</script>
</body>
</html>
